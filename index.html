<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>核函可用清單工具</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;margin:24px;line-height:1.5}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    .muted{color:#666;font-size:14px}
    input[type="file"]{padding:8px}
    input[type="text"], input[type="date"]{padding:8px;border:1px solid #ccc;border-radius:8px}
    button{padding:10px 12px;border:0;border-radius:10px;cursor:pointer}
    button.primary{background:#111;color:#fff}
    button.secondary{background:#eee}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#fafafa;position:sticky;top:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border:1px solid #ddd;border-radius:999px;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#e9f7ef;color:#0b6b2f}
    .bad{background:#fdecea;color:#9b1c1c}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h2>核函可用清單工具</h2>
  <div class="muted">純前端運作：Excel 檔案只在你的瀏覽器解析，不會上傳到伺服器。</div>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".xlsx,.xls" />
      <label class="muted">今日日期：</label>
      <input id="today" type="date" />
      <input id="q" type="text" placeholder="搜尋：核函號碼 / 入簽函號 / 遞補函…" style="min-width:280px" />
      <button id="analyze" class="primary">分析</button>
      <button id="download" class="secondary" disabled>下載結果 Excel（選用）</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card grid2">
    <div>
      <div class="muted">統計</div>
      <div id="stats" style="font-size:18px;margin-top:6px">尚未分析</div>
    </div>
    <div>
      <div class="muted">規則摘要</div>
      <ul class="muted" style="margin:6px 0 0 18px">
        <li>R 含「逾期」→ 不可用</li>
        <li>T 有日期：看 T 是否過期（優先於 L）</li>
        <li>T 無日期：看 L 是否過期</li>
      </ul>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="usable">可用清單</div>
    <div class="tab" data-tab="unusable">不可用</div>
    <div class="tab" data-tab="summary">核函彙總</div>
  </div>

  <div class="card" style="max-height:60vh;overflow:auto">
    <div id="view"></div>
  </div>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // 固定欄位（0-based）：J=9, L=11, R=17, T=19
    const COL = { J: 9, L: 11, R: 17, T: 19 };

    // UI state
    let rows = [];         // 全部判斷結果
    let usableRows = [];   // 可用
    let unusableRows = []; // 不可用
    let summaryRows = [];  // 核函彙總
    let activeTab = "usable";

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const statsEl = $("stats");
    const viewEl = $("view");
    const downloadBtn = $("download");

    // 預設今日日期
    (function initToday(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,"0");
      $("today").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    })();

    function toDateISO(yyyy, mm, dd){
      const d = new Date(yyyy, mm-1, dd);
      if (Number.isNaN(d.getTime())) return null;
      if (d.getFullYear() !== yyyy || d.getMonth() !== (mm-1) || d.getDate() !== dd) return null;
      return d;
    }

    function parseMinguoDate(val){
      if (val === null || val === undefined) return null;
      if (val instanceof Date && !Number.isNaN(val.getTime())) return val;

      const s = String(val).trim();
      if (!s || s.toLowerCase() === "nan") return null;

      const digits = s.replace(/\D/g, "");

      // 民國 yyyMMdd（7碼）: 1150730
      if (digits.length === 7){
        const y = parseInt(digits.slice(0,3),10) + 1911;
        const m = parseInt(digits.slice(3,5),10);
        const d = parseInt(digits.slice(5,7),10);
        return toDateISO(y,m,d);
      }

      // 西元 yyyymmdd（8碼）
      if (digits.length === 8){
        const y = parseInt(digits.slice(0,4),10);
        const m = parseInt(digits.slice(4,6),10);
        const d = parseInt(digits.slice(6,8),10);
        return toDateISO(y,m,d);
      }

      // 114/10/07
      const m = s.match(/^\s*(\d{2,3})\s*\/\s*(\d{1,2})\s*\/\s*(\d{1,2})\s*$/);
      if (m){
        let y = parseInt(m[1],10);
        if (y < 1911) y += 1911;
        const mm = parseInt(m[2],10);
        const dd = parseInt(m[3],10);
        return toDateISO(y,mm,dd);
      }

      return null;
    }

    function isOverdueR(r){
      if (r === null || r === undefined) return false;
      return String(r).includes("逾期");
    }

    function dateOnly(d){
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function judgeUsable(L, R, T, today){
      if (isOverdueR(R)) return { status: "不可用", reason: "R欄標示逾期" };

      const Ld = parseMinguoDate(L);
      const Td = parseMinguoDate(T);

      if (Td){
        if (dateOnly(Td) >= today) return { status: "可用", reason: "T欄未到期" };
        return { status: "不可用", reason: "T欄已到期" };
      }

      if (Ld && dateOnly(Ld) >= today) return { status: "可用", reason: "L欄未到期" };
      return { status: "不可用", reason: "L欄已到期或無有效日期" };
    }

    function fmtDate(d){
      if (!d) return "";
      const pad = (n) => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // ======= B：自動偵測資料起始列 =======
    function looksLikeKhNo(v){
      // 以「至少 6 碼數字」作容錯；若你們核函固定 10 碼，可改成 === 10
      if (v === null || v === undefined) return false;
      const s = String(v).trim();
      if (!s) return false;
      const digits = s.replace(/\D/g, "");
      return digits.length >= 6;
    }

    function detectStartRow(aoa){
      for (let i = 0; i < aoa.length; i++){
        const row = aoa[i] || [];
        if (looksLikeKhNo(row[COL.J])) return i;
      }
      return 0;
    }
    // ===================================

    function buildSummary(usable){
      const map = new Map();
      for (const r of usable){
        const key = r.khNo ?? "";
        if (!map.has(key)) map.set(key, { 核函號碼: key, 可用筆數: 0 });
        map.get(key).可用筆數 += 1;
      }
      return Array.from(map.values()).sort((a,b)=> b.可用筆數 - a.可用筆數 || String(a.核函號碼).localeCompare(String(b.核函號碼)));
    }

    function renderTable(data, columns){
      if (!data.length) return `<div class="muted">無資料</div>`;
      const th = columns.map(c=>`<th>${c}</th>`).join("");
      const trs = data.map(r=>{
        const tds = columns.map(c=>{
          const v = r[c] ?? "";
          return `<td>${String(v).replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>`;
        }).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    function renderTableWithHTML(data, columns){
      if (!data.length) return `<div class="muted">無資料</div>`;
      const th = columns.map(c=>`<th>${c}</th>`).join("");
      const trs = data.map(r=>{
        const tds = columns.map(c=>`<td>${r[c] ?? ""}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    function applySearch(list){
      const q = $("q").value.trim();
      if (!q) return list;
      const qq = q.toLowerCase();
      return list.filter(r=>{
        return [r.khNo, r.khExpire, r.rVal, r.tExpire, r.status, r.reason]
          .some(x => String(x ?? "").toLowerCase().includes(qq));
      });
    }

    function render(){
      const filteredUsable = applySearch(usableRows);
      const filteredUnusable = applySearch(unusableRows);

      const filteredSummary = applySearch(summaryRows.map(s=>({
        khNo: s.核函號碼, usableCount: s.可用筆數
      })));

      if (activeTab === "usable"){
        const data = filteredUsable.map(r=>({
          "Excel列號": r.excelRow,
          "核函號碼(J)": r.khNo,
          "核函到期日(L)": r.khExpire,
          "入簽/遞補(R)": r.rVal,
          "到期日期(T)": r.tExpire,
          "狀態": `<span class="pill ok">可用</span>`,
          "原因": r.reason
        }));
        viewEl.innerHTML = renderTableWithHTML(data, ["Excel列號","核函號碼(J)","核函到期日(L)","入簽/遞補(R)","到期日期(T)","狀態","原因"]);
        return;
      }

      if (activeTab === "unusable"){
        const data = filteredUnusable.map(r=>({
          "Excel列號": r.excelRow,
          "核函號碼(J)": r.khNo,
          "核函到期日(L)": r.khExpire,
          "入簽/遞補(R)": r.rVal,
          "到期日期(T)": r.tExpire,
          "狀態": `<span class="pill bad">不可用</span>`,
          "原因": r.reason
        }));
        viewEl.innerHTML = renderTableWithHTML(data, ["Excel列號","核函號碼(J)","核函到期日(L)","入簽/遞補(R)","到期日期(T)","狀態","原因"]);
        return;
      }

      if (activeTab === "summary"){
        const data = filteredSummary.map(s=>({
          "核函號碼": s.khNo,
          "可用筆數": s.usableCount
        }));
        viewEl.innerHTML = renderTable(data, ["核函號碼","可用筆數"]);
        return;
      }
    }

    function setStatus(msg){ statusEl.textContent = msg; }

    $("analyze").addEventListener("click", async ()=>{
      const f = $("file").files?.[0];
      if (!f){
        setStatus("請先選擇 Excel 檔案。");
        return;
      }

      downloadBtn.disabled = true;
      setStatus("解析中…");

      const todayStr = $("today").value;
      const today = todayStr ? dateOnly(new Date(todayStr)) : dateOnly(new Date());

      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array", cellDates: true });

      const firstSheetName = wb.SheetNames[0];
      const ws = wb.Sheets[firstSheetName];

      // 二維陣列，保留空白（defval）
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: null });

      // B：自動偵測資料起始列
      const startRowIdx = detectStartRow(aoa);
      setStatus(`解析中…（自動偵測資料起始列：第 ${startRowIdx + 1} 列）`);

      rows = [];
      for (let i = startRowIdx; i < aoa.length; i++){
        const row = aoa[i] || [];
        const khNo = row[COL.J];
        const L = row[COL.L];
        const R = row[COL.R];
        const T = row[COL.T];

        // 全空列跳過
        const isAllEmpty = [khNo,L,R,T].every(v => v === null || v === undefined || String(v).trim() === "");
        if (isAllEmpty) continue;

        const judged = judgeUsable(L, R, T, today);

        rows.push({
          excelRow: i + 1,
          khNo: khNo ?? "",
          khExpire: fmtDate(parseMinguoDate(L)),
          rVal: R ?? "",
          tExpire: fmtDate(parseMinguoDate(T)),
          status: judged.status,
          reason: judged.reason
        });
      }

      usableRows = rows.filter(r=>r.status==="可用");
      unusableRows = rows.filter(r=>r.status!=="可用");
      summaryRows = buildSummary(usableRows);

      statsEl.innerHTML = `
        <div>可用：<b>${usableRows.length}</b> 筆　｜　不可用：<b>${unusableRows.length}</b> 筆　｜　核函數：<b>${summaryRows.length}</b></div>
      `;

      setStatus(`完成：${f.name}（工作表：${firstSheetName}；資料起始列：第 ${startRowIdx + 1} 列）`);
      downloadBtn.disabled = false;
      render();
    });

    $("q").addEventListener("input", ()=> render());

    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        activeTab = t.dataset.tab;
        render();
      });
    });

    $("download").addEventListener("click", ()=>{
      if (!rows.length) return;

      const wsAll = XLSX.utils.json_to_sheet(rows.map(r=>({
        "Excel列號": r.excelRow,
        "核函號碼(J)": r.khNo,
        "核函到期日(L)": r.khExpire,
        "入簽/遞補(R)": r.rVal,
        "到期日期(T)": r.tExpire,
        "狀態": r.status,
        "原因": r.reason
      })));

      const wsUsable = XLSX.utils.json_to_sheet(usableRows.map(r=>({
        "Excel列號": r.excelRow,
        "核函號碼(J)": r.khNo,
        "核函到期日(L)": r.khExpire,
        "入簽/遞補(R)": r.rVal,
        "到期日期(T)": r.tExpire,
        "狀態": r.status,
        "原因": r.reason
      })));

      const wsSummary = XLSX.utils.json_to_sheet(summaryRows);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsSummary, "核函彙總");
      XLSX.utils.book_append_sheet(wb, wsUsable, "可用清單");
      XLSX.utils.book_append_sheet(wb, wsAll, "全部判斷");

      XLSX.writeFile(wb, "核函可用結果.xlsx");
    });
  </script>
</body>
</html>
