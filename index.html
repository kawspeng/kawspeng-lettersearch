<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>核函搜尋工具</title>

  <!-- Font: clearer Traditional Chinese -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#050814;
      --bg2:#070a18;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.14);
      --line2: rgba(148,163,184,.22);

      --text:#f3f4f6;
      --muted:#cbd5e1;

      --accent:#60a5fa;
      --accent2:#a78bfa;
      --accent3:#34d399;

      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --shadow2: 0 10px 28px rgba(0,0,0,.26);

      --r:18px;
    }

    *{box-sizing:border-box}

    /* ===== Readability / typography (single source of truth) ===== */
    body{
      margin:0;
      color:var(--text);
      font-family: "Noto Sans TC", ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
      font-size: 16px;
      line-height: 1.65;
      letter-spacing: .2px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;

      background:
        radial-gradient(1200px 600px at 12% 12%, rgba(96,165,250,.28), transparent 58%),
        radial-gradient(900px 520px at 82% 5%, rgba(167,139,250,.26), transparent 60%),
        radial-gradient(900px 520px at 82% 92%, rgba(52,211,153,.14), transparent 62%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 45%, #040612 100%);
    }

    .wrap{max-width:1180px;margin:28px auto 46px;padding:0 18px}
    .topbar{
      display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;
      justify-content:space-between;margin-bottom:14px
    }

    .brand h1{
      margin:0;
      font-size:30px;
      letter-spacing:.4px;
      font-weight:820;
      background: linear-gradient(90deg, rgba(96,165,250,.98), rgba(167,139,250,.98), rgba(52,211,153,.9));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .sub{
      margin-top:10px;
      color: rgba(203,213,225,.92);
      font-size:15px;
      line-height:1.7;
    }
    .sub .author{opacity:.92;margin-left:10px;font-weight:600}

    .pills{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      color: rgba(243,244,246,.92);
      font-size:14px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background: linear-gradient(180deg, var(--accent), var(--accent2));}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-variant-numeric: tabular-nums;
    }
    .num{
      font-variant-numeric: tabular-nums;
      text-align:right;
      display:inline-block;
      min-width: 2ch;
    }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing:.3px;
    }

    .grid{
      display:grid;grid-template-columns:1.22fr .78fr;gap:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid rgba(255,255,255,.14);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(600px 220px at 18% 0%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(540px 220px at 88% 0%, rgba(167,139,250,.14), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .card > *{position:relative}

    .hd{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: rgba(255,255,255,.03);
    }
    .hd .title{
      font-weight:800;
      font-size:16.5px;
      letter-spacing:.2px;
    }
    .mini{
      color: rgba(203,213,225,.9);
      font-size:13.5px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .bd{padding:18px}

    /* Upload */
    .dropzone{
      border:2px dashed rgba(203,213,225,.38);
      border-radius: 18px;
      padding:18px;
      background:
        linear-gradient(180deg, rgba(96,165,250,.12), rgba(167,139,250,.08)),
        rgba(0,0,0,.18);
      cursor:pointer;
      transition: .16s ease;
    }
    .dropzone:hover{
      transform: translateY(-1px);
      border-color: rgba(96,165,250,.82);
      box-shadow: 0 0 0 6px rgba(96,165,250,.12);
    }
    .dropzone.dragover{
      border-color: rgba(52,211,153,.95);
      box-shadow: 0 0 0 7px rgba(52,211,153,.14);
      background:
        linear-gradient(180deg, rgba(52,211,153,.12), rgba(96,165,250,.10)),
        rgba(0,0,0,.18);
    }
    .dropzone input{display:none}

    .dz-row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .dz-ico{
      width:54px;height:54px;border-radius:18px;
      background: radial-gradient(20px 20px at 30% 20%, rgba(255,255,255,.18), transparent 60%),
                  linear-gradient(180deg, rgba(96,165,250,.24), rgba(167,139,250,.18));
      border:1px solid rgba(255,255,255,.16);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 12px 22px rgba(0,0,0,.22);
    }
    .dz-main b{font-size:16px}
    .dz-main .muted{margin-top:4px}
    .fileline{margin-top:8px;color: rgba(203,213,225,.92);font-size:14px}

    /* Controls */
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    label.muted{font-size:14px;color: rgba(203,213,225,.92)}

    input[type="text"], input[type="date"]{
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-size:15.5px;
    }
    input[type="text"]::placeholder{color: rgba(203,213,225,.72)}
    input[type="text"]:focus, input[type="date"]:focus{
      border-color: rgba(96,165,250,.9);
      box-shadow: 0 0 0 7px rgba(96,165,250,.16);
    }

    button{
      padding:12px 16px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      cursor:pointer;
      font-size:15.5px;
      font-weight:750;
      transition: .16s ease;
      color: rgba(243,244,246,.96);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 20px rgba(0,0,0,.16);
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    button:focus-visible, .tab:focus-visible, #dropzone:focus-visible{
      outline:none;
      box-shadow: 0 0 0 7px rgba(96,165,250,.18);
    }

    .primary{
      border-color: rgba(255,255,255,.18);
      color:#071022;
      background: linear-gradient(90deg, rgba(96,165,250,.98), rgba(167,139,250,.98));
    }
    .primary:hover{ filter: brightness(1.03); }
    .ghost{
      background: transparent;
      border-color: rgba(203,213,225,.22);
      color: rgba(203,213,225,.92);
    }

    /* Hint / Status */
    .hint{
      margin-top:12px;
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(203,213,225,.95);
      font-size:14px;
    }
    .hint strong{color: rgba(243,244,246,.98)}

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding:14px 14px;
      background: rgba(0,0,0,.20);
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }
    .kpi .label{color: rgba(203,213,225,.9);font-size:13px}
    .kpi .val{
      font-size:22px;font-weight:900;margin-top:6px;letter-spacing:.2px;
      font-variant-numeric: tabular-nums;
    }
    .kpi .tag{display:inline-block;margin-top:8px;font-size:13px;color: rgba(203,213,225,.82)}

    /* Tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .tab{
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: rgba(203,213,225,.9);
      cursor:pointer;
      transition:.16s;
      font-size:14px;
      font-weight:750;
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      color:#061022;
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(90deg, rgba(96,165,250,.92), rgba(167,139,250,.92));
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
    }

    /* Table */
    .tableWrap{
      max-height: 64vh;
      overflow:auto;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      scrollbar-gutter: stable;
    }
    .tableWrap::-webkit-scrollbar{ height: 10px; width: 10px; }
    .tableWrap::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border-radius: 999px;
    }
    .tableWrap::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.22);
    }

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:15px;
      line-height:1.55;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0; z-index:1;
      background: rgba(15,23,42,.70);
      backdrop-filter: blur(12px);
      color: rgba(243,244,246,.96);
      font-weight:900;
      letter-spacing:.25px;
    }
    td{color: rgba(243,244,246,.92)}
    tr:hover td{background: rgba(255,255,255,.04)}

    .statusPill{
      display:inline-flex;align-items:center;gap:8px;
      padding:5px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:13.5px;
      font-weight:850;
      line-height:1.2;
      white-space:nowrap;
    }
    .statusPill.ok{color: rgba(52,211,153,.98); background: rgba(52,211,153,.12); border-color: rgba(52,211,153,.22)}
    .statusPill.bad{color: rgba(251,113,133,.98); background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.22)}

    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; }
      button:hover, .tab:hover, .dropzone:hover{ transform:none !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>核函搜尋工具</h1>
        <div class="sub">
          純前端運作：Excel 只在瀏覽器解析，不上傳、不留存。
          <span class="author">作者：彭鼎智</span>
        </div>
      </div>
      <div class="pills">
        <span class="pill"><span class="dot"></span>正式版 v1.4</span>
        <span class="pill">本機使用次數：<span id="useCount" class="mono">0</span></span>
        <button id="resetCount" class="ghost">清除計數</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div class="title">上傳與分析</div>
          <div class="mini">欄位：<b>J</b>=核函號碼、<b>L</b>=核函到期、<b>R</b>=入簽/遞補、<b>T</b>=到期日期</div>
        </div>
        <div class="bd">
          <div id="dropzone" class="dropzone" role="button" aria-label="上傳 Excel" tabindex="0">
            <input id="fileInput" type="file" accept=".xlsx,.xls" />
            <div class="dz-row">
              <div class="dz-ico" aria-hidden="true">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10m0 0l-4-4m4 4l4-4" stroke="rgba(243,244,246,.95)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 15v3a3 3 0 003 3h8a3 3 0 003-3v-3" stroke="rgba(243,244,246,.70)" stroke-width="2.2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="dz-main">
                <b>拖曳 Excel 檔案到此</b>
                <div class="muted">或點擊選擇檔案（支援 .xlsx / .xls）</div>
                <div id="picked" class="fileline"></div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <label class="muted">今日日期</label>
            <input id="today" type="date" />
            <div class="spacer"></div>
            <button id="analyze" class="primary">開始分析</button>
            <button id="download" class="ghost" disabled>下載結果（選用）</button>
          </div>

          <div id="status" class="hint">尚未分析</div>

          <div class="hint">
            <strong>判斷規則</strong>：R 含「逾期」→ 不可用；若 T 有日期則以 T 判斷是否到期（優先於 L）；T 無日期則以 L 判斷。
            <br><strong>起始列</strong>：自動偵測第一筆 J 欄看起來像核函號碼後開始讀取。
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div class="title">結果概覽</div>
          <div class="mini">搜尋會套用到目前分頁</div>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="label">可用</div>
              <div class="val" id="kpiUsable">0</div>
              <div class="tag">依規則判斷</div>
            </div>
            <div class="kpi">
              <div class="label">不可用</div>
              <div class="val" id="kpiUnusable">0</div>
              <div class="tag">逾期/到期</div>
            </div>
            <div class="kpi">
              <div class="label">核函數</div>
              <div class="val" id="kpiKh">0</div>
              <div class="tag">以核函號碼彙總</div>
            </div>
            <div class="kpi">
              <div class="label">資料起始列</div>
              <div class="val" id="kpiStart">-</div>
              <div class="tag">自動偵測</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <input id="q" type="text" placeholder="搜尋：核函號碼 / 入簽函 / 遞補函 / 原因…" style="width:100%" />
          </div>

          <div class="hint" style="margin-top:14px">
            小技巧：可直接複製表格內容，或按「下載結果」匯出 Excel（選用）。
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="usable">可用清單</div>
      <div class="tab" data-tab="unusable">不可用</div>
      <div class="tab" data-tab="summary">核函彙總</div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="title" id="tableTitle">可用清單</div>
        <div class="mini" id="tableMeta">尚未分析</div>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <div id="view" class="muted" style="padding:16px;font-size:15px">尚未分析</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/cpexcel.full.mjs" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const COL = { J: 9, L: 11, R: 17, T: 19 };

    let uploadedFile = null;
    let rows = [];
    let usableRows = [];
    let unusableRows = [];
    let summaryRows = [];
    let activeTab = "usable";
    let lastStartRow = null;
    let lastSheetName = null;

    const $ = (id) => document.getElementById(id);

    // Use count (local only)
    const LS_KEY = "kh_tool_use_count_v1";
    function getUseCount(){ return parseInt(localStorage.getItem(LS_KEY) || "0", 10); }
    function setUseCount(v){ localStorage.setItem(LS_KEY, String(v)); $("useCount").textContent = String(v); }
    function bumpUseCount(){ setUseCount(getUseCount() + 1); }
    setUseCount(getUseCount());
    $("resetCount").addEventListener("click", ()=> setUseCount(0));

    // Init today
    (function initToday(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,"0");
      $("today").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    })();

    // Upload (click + drag)
    const dz = $("dropzone");
    const fileInput = $("fileInput");

    dz.addEventListener("click", () => fileInput.click());
    dz.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); fileInput.click(); }
    });
    dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.classList.add("dragover"); });
    dz.addEventListener("dragleave", ()=> dz.classList.remove("dragover"));
    dz.addEventListener("drop", (e)=>{
      e.preventDefault();
      dz.classList.remove("dragover");
      if (e.dataTransfer.files?.length) setFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener("change", ()=>{
      if (fileInput.files?.length) setFile(fileInput.files[0]);
    });

    function setPicked(msg){ $("picked").textContent = msg || ""; }
    function setStatus(msg){ $("status").textContent = msg || ""; }

    function setFile(file){
      if (!file || !file.name.match(/\.(xlsx|xls)$/i)){
        alert("請選擇 Excel 檔案（.xlsx / .xls）");
        return;
      }
      uploadedFile = file;
      setPicked(`已選擇：${file.name}`);
      setStatus("已載入檔案，請按「開始分析」。");
    }

    // Date parsing
    function toDateISO(yyyy, mm, dd){
      const d = new Date(yyyy, mm-1, dd);
      if (Number.isNaN(d.getTime())) return null;
      if (d.getFullYear() !== yyyy || d.getMonth() !== (mm-1) || d.getDate() !== dd) return null;
      return d;
    }

    function parseMinguoDate(val){
      if (val === null || val === undefined) return null;
      if (val instanceof Date && !Number.isNaN(val.getTime())) return val;

      const s = String(val).trim();
      if (!s || s.toLowerCase() === "nan") return null;

      const digits = s.replace(/\D/g, "");

      if (digits.length === 7){
        const y = parseInt(digits.slice(0,3),10) + 1911;
        const m = parseInt(digits.slice(3,5),10);
        const d = parseInt(digits.slice(5,7),10);
        return toDateISO(y,m,d);
      }

      if (digits.length === 8){
        const y = parseInt(digits.slice(0,4),10);
        const m = parseInt(digits.slice(4,6),10);
        const d = parseInt(digits.slice(6,8),10);
        return toDateISO(y,m,d);
      }

      const m = s.match(/^\s*(\d{2,3})\s*\/\s*(\d{1,2})\s*\/\s*(\d{1,2})\s*$/);
      if (m){
        let y = parseInt(m[1],10);
        if (y < 1911) y += 1911;
        const mm = parseInt(m[2],10);
        const dd = parseInt(m[3],10);
        return toDateISO(y,mm,dd);
      }

      return null;
    }

    function dateOnly(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function fmtDate(d){
      if (!d) return "";
      const pad = (n) => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Rules
    function isOverdueR(r){
      if (r === null || r === undefined) return false;
      return String(r).includes("逾期");
    }

    function judgeUsable(L, R, T, today, workerName){
  // 新增規則：移工姓名有值且不是「未使用」 => 直接排除
  if (isActuallyUsedByWorker(workerName)){
    return { status: "不可用", reason: "已被移工使用（移工姓名有值）" };
  }

  if (isOverdueR(R)) return { status: "不可用", reason: "R欄標示逾期" };

  const Ld = parseMinguoDate(L);
  const Td = parseMinguoDate(T);

  if (Td){
    if (dateOnly(Td) >= today) return { status: "可用", reason: "T欄未到期" };
    return { status: "不可用", reason: "T欄已到期" };
  }

  if (Ld && dateOnly(Ld) >= today) return { status: "可用", reason: "L欄未到期" };
  return { status: "不可用", reason: "L欄已到期或無有效日期" };
}


    // Auto detect start row
    function looksLikeKhNo(v){
      if (v === null || v === undefined) return false;
      const s = String(v).trim();
      if (!s) return false;
      const digits = s.replace(/\D/g, "");
      return digits.length >= 6;
    }

    function detectStartRow(aoa){
      for (let i = 0; i < aoa.length; i++){
        const row = aoa[i] || [];
        if (looksLikeKhNo(row[COL.J])) return i;
      }
      return 0;
    }
// ===== 新增：自動找「移工姓名」欄 + 判斷是否已被使用 =====
function findColumnIndexByHeader(aoa, headerText){
  const target = String(headerText).trim();
  const maxRows = Math.min(30, aoa.length);
  for (let r = 0; r < maxRows; r++){
    const row = aoa[r] || [];
    for (let c = 0; c < row.length; c++){
      const v = row[c];
      if (v === null || v === undefined) continue;
      const s = String(v).trim();
      if (s === target || s.includes(target)) return c;
    }
  }
  return null;
}

function isActuallyUsedByWorker(nameVal){
  // 只要包含「未使用」都視為仍可用名額（例如：未使用3人）
  if (nameVal === null || nameVal === undefined) return false;
  const s = String(nameVal).trim();
  if (!s) return false;
  if (s.includes("未使用")) return false;
  return true; // 有內容且不是「未使用」 => 視為已被移工使用
}

    
    // Summary
    function buildSummary(usable){
      const map = new Map();
      for (const r of usable){
        const key = r.khNo ?? "";
        if (!map.has(key)) map.set(key, { 核函號碼: key, 可用筆數: 0 });
        map.get(key).可用筆數 += 1;
      }
      return Array.from(map.values())
        .sort((a,b)=> b.可用筆數 - a.可用筆數 || String(a.核函號碼).localeCompare(String(b.核函號碼)));
    }

    // Render helpers
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderTableWithHTML(data, columns){
      if (!data.length) return `<div class="muted" style="padding:16px">無資料</div>`;
      const th = columns.map(c=>`<th>${escapeHtml(c)}</th>`).join("");
      const trs = data.map(r=>{
        const tds = columns.map(c=>`<td>${r[c] ?? ""}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    function renderTable(data, columns){
      if (!data.length) return `<div class="muted" style="padding:16px">無資料</div>`;
      const th = columns.map(c=>`<th>${escapeHtml(c)}</th>`).join("");
      const trs = data.map(r=>{
        const tds = columns.map(c=>`<td>${escapeHtml(r[c] ?? "")}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    // Search
    function applySearch(list){
      const q = $("q").value.trim().toLowerCase();
      if (!q) return list;
      return list.filter(r=>{
        return [r.khNo, r.khExpire, r.rVal, r.tExpire, r.status, r.reason, r.excelRow]
          .some(x => String(x ?? "").toLowerCase().includes(q));
      });
    }

    function setTableHeader(){
      const titleMap = { usable:"可用清單", unusable:"不可用", summary:"核函彙總" };
      $("tableTitle").textContent = titleMap[activeTab] || "結果";
      const meta = [];
      if (lastSheetName) meta.push(`工作表：${lastSheetName}`);
      if (lastStartRow !== null) meta.push(`資料起始列：第 ${lastStartRow + 1} 列`);
      $("tableMeta").textContent = meta.length ? meta.join(" ｜ ") : "尚未分析";
    }

    function render(){
      setTableHeader();
      const view = $("view");

      if (activeTab === "usable"){
        const data = applySearch(usableRows).map(r=>({
          "狀態": `<span class="statusPill ok">可用</span>`,
          "核函號碼(J)": `<span class="code">${escapeHtml(r.khNo)}</span>`,
          "核函到期(L)": escapeHtml(r.khExpire),
          "入簽/遞補(R)": escapeHtml(r.rVal),
          "到期日期(T)": escapeHtml(r.tExpire),
          "Excel列號": `<span class="mono num">${escapeHtml(r.excelRow)}</span>`,
          "原因": escapeHtml(r.reason)
        }));
        view.innerHTML = renderTableWithHTML(data, ["狀態","核函號碼(J)","核函到期(L)","入簽/遞補(R)","到期日期(T)","Excel列號","原因"]);
        return;
      }

      if (activeTab === "unusable"){
        const data = applySearch(unusableRows).map(r=>({
          "狀態": `<span class="statusPill bad">不可用</span>`,
          "核函號碼(J)": `<span class="code">${escapeHtml(r.khNo)}</span>`,
          "核函到期(L)": escapeHtml(r.khExpire),
          "入簽/遞補(R)": escapeHtml(r.rVal),
          "到期日期(T)": escapeHtml(r.tExpire),
          "Excel列號": `<span class="mono num">${escapeHtml(r.excelRow)}</span>`,
          "原因": escapeHtml(r.reason)
        }));
        view.innerHTML = renderTableWithHTML(data, ["狀態","核函號碼(J)","核函到期(L)","入簽/遞補(R)","到期日期(T)","Excel列號","原因"]);
        return;
      }

      if (activeTab === "summary"){
        const q = $("q").value.trim().toLowerCase();
        let list = summaryRows.map(s=>({ khNo:s.核函號碼, cnt:s.可用筆數 }));
        if (q){
          list = list.filter(x => [x.khNo, x.cnt].some(v=> String(v).toLowerCase().includes(q)));
        }
        const data = list.map(x=>({
          "核函號碼": `<span class="code">${escapeHtml(x.khNo)}</span>`,
          "可用筆數": `<span class="mono num">${escapeHtml(x.cnt)}</span>`
        }));
        view.innerHTML = renderTableWithHTML(data, ["核函號碼","可用筆數"]);
        return;
      }
    }

    // Tabs
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        activeTab = t.dataset.tab;
        render();
      });
    });

    $("q").addEventListener("input", ()=> render());

    // Analyze
    $("analyze").addEventListener("click", async ()=>{
      if (!uploadedFile){
        alert("請先拖曳或選擇 Excel 檔案。");
        return;
      }

      $("download").disabled = true;
      setStatus("解析中…");

      const todayStr = $("today").value;
      const today = todayStr ? dateOnly(new Date(todayStr)) : dateOnly(new Date());

      const buf = await uploadedFile.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array", cellDates: true, codepage: 950 });

      const sheetName = wb.SheetNames[0];
      lastSheetName = sheetName;
      const ws = wb.Sheets[sheetName];

      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: null });
      const workerNameCol = findColumnIndexByHeader(aoa, "移工姓名");
      const startRowIdx = detectStartRow(aoa);
      lastStartRow = startRowIdx;

      rows = [];
      for (let i = startRowIdx; i < aoa.length; i++){
        const row = aoa[i] || [];
        const khNo = row[COL.J];
        const L = row[COL.L];
        const R = row[COL.R];
        const T = row[COL.T];
        const workerName = (workerNameCol !== null) ? row[workerNameCol] : null;

        const isAllEmpty = [khNo,L,R,T].every(v => v === null || v === undefined || String(v).trim() === "");
        if (isAllEmpty) continue;

        const judged = judgeUsable(L, R, T, today, workerName);

        rows.push({
          excelRow: i + 1,
          khNo: khNo ?? "",
          khExpire: fmtDate(parseMinguoDate(L)),
          rVal: R ?? "",
          tExpire: fmtDate(parseMinguoDate(T)),
          status: judged.status,
          reason: judged.reason
        });
      }

      usableRows = rows.filter(r=>r.status==="可用");
      unusableRows = rows.filter(r=>r.status!=="可用");
      summaryRows = buildSummary(usableRows);

      $("kpiUsable").textContent = String(usableRows.length);
      $("kpiUnusable").textContent = String(unusableRows.length);
      $("kpiKh").textContent = String(summaryRows.length);
      $("kpiStart").textContent = `第 ${startRowIdx + 1} 列`;

      setStatus(`完成：${uploadedFile.name}（工作表：${sheetName}；資料起始列：第 ${startRowIdx + 1} 列）`);
      $("download").disabled = false;

      // bump local counter only after successful analysis
      const LS_KEY = "kh_tool_use_count_v1";
      const cur = parseInt(localStorage.getItem(LS_KEY) || "0", 10);
      localStorage.setItem(LS_KEY, String(cur + 1));
      $("useCount").textContent = String(cur + 1);

      render();
    });

    // Download (optional)
    $("download").addEventListener("click", ()=>{
      if (!rows.length) return;

      const all = rows.map(r=>({
        "Excel列號": r.excelRow,
        "核函號碼(J)": r.khNo,
        "核函到期(L)": r.khExpire,
        "入簽/遞補(R)": r.rVal,
        "到期日期(T)": r.tExpire,
        "狀態": r.status,
        "原因": r.reason
      }));

      const usable = usableRows.map(r=>({
        "Excel列號": r.excelRow,
        "核函號碼(J)": r.khNo,
        "核函到期(L)": r.khExpire,
        "入簽/遞補(R)": r.rVal,
        "到期日期(T)": r.tExpire,
        "狀態": r.status,
        "原因": r.reason
      }));

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), "核函彙總");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(usable), "可用清單");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(all), "全部判斷");

      XLSX.writeFile(wb, "核函可用結果.xlsx");
    });
  </script>
</body>
</html>


