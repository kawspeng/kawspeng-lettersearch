<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>核函可用清單工具</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --card:#0b1226;
      --card2:#0a1533;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.18);
      --accent:#60a5fa;
      --accent2:#a78bfa;
      --ok:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow: 0 12px 30px rgba(0,0,0,.22);
      --shadow2: 0 8px 18px rgba(0,0,0,.18);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 15% 15%, rgba(96,165,250,.18), transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, rgba(167,139,250,.18), transparent 55%),
                  linear-gradient(180deg, #070a14 0%, #090d1a 40%, #060814 100%);
      color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans TC",sans-serif;
      line-height:1.5;
    }

    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .topbar{
      display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end;
      justify-content:space-between; margin-bottom:14px
    }
    .brand h1{margin:0;font-size:22px;letter-spacing:.2px}
    .brand .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.04); color:var(--muted); font-size:12px
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      background: rgba(255,255,255,.02);
    }
    .card .hd .title{font-weight:650}
    .card .bd{padding:16px}

    .muted{color:var(--muted);font-size:13px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    /* Dropzone */
    .dropzone{
      border:1.6px dashed rgba(148,163,184,.45);
      border-radius: 16px;
      padding:18px;
      background: linear-gradient(180deg, rgba(96,165,250,.08), rgba(167,139,250,.05));
      cursor:pointer;
      transition: .15s ease;
    }
    .dropzone:hover{ transform: translateY(-1px); border-color: rgba(96,165,250,.7); }
    .dropzone.dragover{
      border-color: rgba(96,165,250,.95);
      box-shadow: 0 0 0 4px rgba(96,165,250,.18);
    }
    .dropzone input{display:none}
    .dz-row{display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap}
    .dz-ico{
      width:44px;height:44px;border-radius:14px;
      background: rgba(96,165,250,.16);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(96,165,250,.25)
    }
    .dz-ico svg{opacity:.95}
    .dz-main b{font-size:14px}
    .dz-file{margin-top:6px;color:var(--muted);font-size:13px}

    /* Controls */
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}

    input[type="text"], input[type="date"]{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    input[type="text"]::placeholder{color: rgba(148,163,184,.75)}
    input[type="text"]:focus, input[type="date"]:focus{
      border-color: rgba(96,165,250,.7);
      box-shadow: 0 0 0 4px rgba(96,165,250,.14);
    }

    button{
      padding:10px 14px;
      border-radius: 12px;
      border:1px solid transparent;
      cursor:pointer;
      font-size:14px;
      transition: .15s ease;
      user-select:none;
      color:var(--text);
      background: rgba(255,255,255,.06);
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .primary{
      background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
      border-color: rgba(255,255,255,.12);
      color: #081028;
      font-weight: 700;
    }
    .primary:hover{ filter: brightness(1.02); }
    .ghost{
      background: transparent;
      border:1px solid rgba(148,163,184,.25);
      color: var(--muted);
    }

    /* KPI */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      border:1px solid rgba(148,163,184,.16);
      border-radius: 14px;
      padding:12px 12px;
      background: rgba(0,0,0,.18);
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .val{font-size:18px;font-weight:750;margin-top:4px}
    .kpi .tag{display:inline-block;margin-top:6px;font-size:12px;color:var(--muted)}

    /* Tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(148,163,184,.2);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      cursor:pointer;
      transition:.15s;
      font-size:13px;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(96,165,250,.55);
      background: rgba(96,165,250,.14);
      box-shadow: 0 0 0 4px rgba(96,165,250,.08);
    }

    /* Table */
    .tableWrap{
      max-height: 62vh;
      overflow:auto;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(0,0,0,.18);
    }
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(148,163,184,.12);
      font-size:13px;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0; z-index:1;
      background: rgba(15,23,42,.75);
      backdrop-filter: blur(10px);
      color: rgba(229,231,235,.9);
      font-weight:650;
    }
    td{color: rgba(229,231,235,.88)}
    tr:hover td{background: rgba(255,255,255,.03)}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 8px;border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      font-size:12px;
    }
    .pill.ok{color: rgba(52,211,153,.95); background: rgba(52,211,153,.10); border-color: rgba(52,211,153,.20)}
    .pill.bad{color: rgba(251,113,133,.95); background: rgba(251,113,133,.10); border-color: rgba(251,113,133,.20)}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size:13px;
    }
    .mini{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: var(--muted); font-size:12px;
    }
    .mini b{color:var(--text)}
    a{color:inherit}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>鎵興｜核函可用清單工具</h1>
        <div class="sub">純前端運作：Excel 只在瀏覽器解析，不上傳、不留存。</div>
      </div>
      <div class="actions">
        <span class="badge"><span class="dot"></span>正式版 v1.2</span>
        <span class="badge">本機使用次數：<span id="useCount" class="mono">0</span></span>
        <button id="resetCount" class="ghost">清除計數</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Upload + Controls -->
      <div class="card">
        <div class="hd">
          <div class="title">上傳與分析</div>
          <div class="mini">
            <span>欄位：<b>J</b>=核函號碼、<b>L</b>=核函到期、<b>R</b>=入簽/遞補、<b>T</b>=到期日期</span>
          </div>
        </div>
        <div class="bd">
          <div id="dropzone" class="dropzone" role="button" aria-label="上傳 Excel">
            <input id="fileInput" type="file" accept=".xlsx,.xls" />
            <div class="dz-row">
              <div class="dz-ico" aria-hidden="true">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10m0 0l-4-4m4 4l4-4" stroke="rgba(229,231,235,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 15v3a3 3 0 003 3h8a3 3 0 003-3v-3" stroke="rgba(229,231,235,.65)" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="dz-main">
                <b>拖曳 Excel 檔案到此</b>
                <div class="muted">或點擊選擇檔案（支援 .xlsx / .xls）</div>
                <div id="picked" class="dz-file"></div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <label class="muted">今日日期</label>
            <input id="today" type="date" />
            <div class="spacer"></div>
            <button id="analyze" class="primary">分析</button>
            <button id="download" class="ghost" disabled>下載結果（選用）</button>
          </div>

          <div id="status" class="hint">尚未分析</div>

          <div class="hint">
            規則：R 含「逾期」→ 不可用；若 T 有日期則以 T 判斷是否到期（優先於 L）；T 無日期則以 L 判斷。
            資料起始列採自動偵測：找出第一筆 J 欄看起來像核函號碼後開始讀取。
          </div>
        </div>
      </div>

      <!-- Right: KPIs + Search -->
      <div class="card">
        <div class="hd">
          <div class="title">結果概覽</div>
          <div class="mini">搜尋會套用到目前分頁</div>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <div class="label">可用</div>
              <div class="val" id="kpiUsable">0</div>
              <div class="tag">依規則判斷</div>
            </div>
            <div class="kpi">
              <div class="label">不可用</div>
              <div class="val" id="kpiUnusable">0</div>
              <div class="tag">逾期/到期</div>
            </div>
            <div class="kpi">
              <div class="label">核函數</div>
              <div class="val" id="kpiKh">0</div>
              <div class="tag">以核函號碼彙總</div>
            </div>
            <div class="kpi">
              <div class="label">資料起始列</div>
              <div class="val" id="kpiStart">-</div>
              <div class="tag">自動偵測</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <input id="q" type="text" placeholder="搜尋：核函號碼 / 入簽函 / 遞補函 / 原因…" style="width:100%" />
          </div>

          <div class="hint" style="margin-top:12px">
            小技巧：可直接複製表格內容，或按「下載結果」匯出 Excel（選用）。
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="usable">可用清單</div>
      <div class="tab" data-tab="unusable">不可用</div>
      <div class="tab" data-tab="summary">核函彙總</div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="title" id="tableTitle">可用清單</div>
        <div class="mini" id="tableMeta">尚未分析</div>
      </div>
      <div class="bd">
        <div class="tableWrap">
          <div id="view" class="muted" style="padding:14px">尚未分析</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // 欄位（0-based）：J=9, L=11, R=17, T=19
    const COL = { J: 9, L: 11, R: 17, T: 19 };

    // State
    let uploadedFile = null;
    let rows = [];
    let usableRows = [];
    let unusableRows = [];
    let summaryRows = [];
    let activeTab = "usable";
    let lastStartRow = null;
    let lastSheetName = null;

    const $ = (id) => document.getElementById(id);

    // ===== 使用次數（僅 localStorage，不上傳）=====
    const LS_KEY = "kh_tool_use_count_v1";
    function getUseCount(){ return parseInt(localStorage.getItem(LS_KEY) || "0", 10); }
    function setUseCount(v){ localStorage.setItem(LS_KEY, String(v)); $("useCount").textContent = String(v); }
    function bumpUseCount(){ setUseCount(getUseCount() + 1); }
    setUseCount(getUseCount());
    $("resetCount").addEventListener("click", ()=> setUseCount(0));

    // ===== 預設今日日期 =====
    (function initToday(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,"0");
      $("today").value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    })();

    // ===== 上傳：點擊＋拖曳 =====
    const dz = $("dropzone");
    const fileInput = $("fileInput");

    dz.addEventListener("click", () => fileInput.click());
    dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.classList.add("dragover"); });
    dz.addEventListener("dragleave", ()=> dz.classList.remove("dragover"));
    dz.addEventListener("drop", (e)=>{
      e.preventDefault();
      dz.classList.remove("dragover");
      if (e.dataTransfer.files?.length) setFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener("change", ()=>{
      if (fileInput.files?.length) setFile(fileInput.files[0]);
    });

    function setPicked(msg){ $("picked").textContent = msg || ""; }
    function setStatus(msg){ $("status").textContent = msg || ""; }

    function setFile(file){
      if (!file || !file.name.match(/\.(xlsx|xls)$/i)){
        alert("請選擇 Excel 檔案（.xlsx / .xls）");
        return;
      }
      uploadedFile = file;
      setPicked(`已選擇：${file.name}`);
      setStatus("已載入檔案，請按「分析」。");
    }

    // ===== 日期解析 =====
    function toDateISO(yyyy, mm, dd){
      const d = new Date(yyyy, mm-1, dd);
      if (Number.isNaN(d.getTime())) return null;
      if (d.getFullYear() !== yyyy || d.getMonth() !== (mm-1) || d.getDate() !== dd) return null;
      return d;
    }

    function parseMinguoDate(val){
      if (val === null || val === undefined) return null;
      if (val instanceof Date && !Number.isNaN(val.getTime())) return val;

      const s = String(val).trim();
      if (!s || s.toLowerCase() === "nan") return null;

      const digits = s.replace(/\D/g, "");

      // 民國 yyyMMdd（7碼）
      if (digits.length === 7){
        const y = parseInt(digits.slice(0,3),10) + 1911;
        const m = parseInt(digits.slice(3,5),10);
        const d = parseInt(digits.slice(5,7),10);
        return toDateISO(y,m,d);
      }

      // 西元 yyyymmdd（8碼）
      if (digits.length === 8){
        const y = parseInt(digits.slice(0,4),10);
        const m = parseInt(digits.slice(4,6),10);
        const d = parseInt(digits.slice(6,8),10);
        return toDateISO(y,m,d);
      }

      // 114/10/07
      const m = s.match(/^\s*(\d{2,3})\s*\/\s*(\d{1,2})\s*\/\s*(\d{1,2})\s*$/);
      if (m){
        let y = parseInt(m[1],10);
        if (y < 1911) y += 1911;
        const mm = parseInt(m[2],10);
        const dd = parseInt(m[3],10);
        return toDateISO(y,mm,dd);
      }

      return null;
    }

    function dateOnly(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function fmtDate(d){
      if (!d) return "";
      const pad = (n) => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // ===== 規則判斷 =====
    function isOverdueR(r){
      if (r === null || r === undefined) return false;
      return String(r).includes("逾期");
    }

    function judgeUsable(L, R, T, today){
      if (isOverdueR(R)) return { status: "不可用", reason: "R欄標示逾期" };

      const Ld = parseMinguoDate(L);
      const Td = parseMinguoDate(T);

      if (Td){
        if (dateOnly(Td) >= today) return { status: "可用", reason: "T欄未到期" };
        return { status: "不可用", reason: "T欄已到期" };
      }

      if (Ld && dateOnly(Ld) >= today) return { status: "可用", reason: "L欄未到期" };
      return { status: "不可用", reason: "L欄已到期或無有效日期" };
    }

    // ===== B：自動偵測資料起始列 =====
    function looksLikeKhNo(v){
      // 容錯：至少 6 碼數字；若你們核函固定 10 碼，可改成 === 10
      if (v === null || v === undefined) return false;
      const s = String(v).trim();
      if (!s) return false;
      const digits = s.replace(/\D/g, "");
      return digits.length >= 6;
    }

    function detectStartRow(aoa){
      for (let i = 0; i < aoa.length; i++){
        const row = aoa[i] || [];
        if (looksLikeKhNo(row[COL.J])) return i;
      }
      return 0;
    }

    // ===== 彙總 =====
    function buildSummary(usable){
      const map = new Map();
      for (const r of usable){
        const key = r.khNo ?? "";
        if (!map.has(key)) map.set(key, { 核函號碼: key, 可用筆數: 0 });
        map.get(key).可用筆數 += 1;
      }
      return Array.from(map.values())
        .sort((a,b)=> b.可用筆數 - a.可用筆數 || String(a.核函號碼).localeCompare(String(b.核函號碼)));
    }

    // ===== 表格渲染 =====
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function renderTableWithHTML(data, columns){
      if (!data.length) return `<div class="muted" style="padding:14px">無資料</div>`;
      const th = columns.map(c=>`<th>${escapeHtml(c)}</th>`).join("");
      const trs = data.map(r=>{
        const tds = columns.map(c=>`<td>${r[c] ?? ""}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    function renderTable(data, columns){
      if (!data.length) return `<div class="muted" style="padding:14px">無資料</div>`;
      const th = columns.map(c=>`<th>${escapeHtml(c)}</th>`).join("");
      const trs = data.map(r=>{
        const tds = columns.map(c=>`<td>${escapeHtml(r[c] ?? "")}</td>`).join("");
        return `<tr>${tds}</tr>`;
      }).join("");
      return `<table><thead><tr>${th}</tr></thead><tbody>${trs}</tbody></table>`;
    }

    // ===== 搜尋（套用目前分頁）=====
    function applySearch(list){
      const q = $("q").value.trim().toLowerCase();
      if (!q) return list;
      return list.filter(r=>{
        return [
          r.khNo, r.khExpire, r.rVal, r.tExpire, r.status, r.reason,
          r.excelRow
        ].some(x => String(x ?? "").toLowerCase().includes(q));
      });
    }

    function setTableHeader(){
      const titleMap = { usable:"可用清單", unusable:"不可用", summary:"核函彙總" };
      $("tableTitle").textContent = titleMap[activeTab] || "結果";
      const meta = [];
      if (lastSheetName) meta.push(`工作表：${lastSheetName}`);
      if (lastStartRow !== null) meta.push(`資料起始列：第 ${lastStartRow + 1} 列`);
      $("tableMeta").textContent = meta.length ? meta.join(" ｜ ") : "尚未分析";
    }

    function render(){
      setTableHeader();
      const view = $("view");

      if (activeTab === "usable"){
        const data = applySearch(usableRows).map(r=>({
          "狀態": `<span class="pill ok">可用</span>`,
          "核函號碼(J)": escapeHtml(r.khNo),
          "核函到期(L)": escapeHtml(r.khExpire),
          "入簽/遞補(R)": escapeHtml(r.rVal),
          "到期日期(T)": escapeHtml(r.tExpire),
          "Excel列號": escapeHtml(r.excelRow),
          "原因": escapeHtml(r.reason)
        }));
        view.innerHTML = renderTableWithHTML(data, ["狀態","核函號碼(J)","核函到期(L)","入簽/遞補(R)","到期日期(T)","Excel列號","原因"]);
        return;
      }

      if (activeTab === "unusable"){
        const data = applySearch(unusableRows).map(r=>({
          "狀態": `<span class="pill bad">不可用</span>`,
          "核函號碼(J)": escapeHtml(r.khNo),
          "核函到期(L)": escapeHtml(r.khExpire),
          "入簽/遞補(R)": escapeHtml(r.rVal),
          "到期日期(T)": escapeHtml(r.tExpire),
          "Excel列號": escapeHtml(r.excelRow),
          "原因": escapeHtml(r.reason)
        }));
        view.innerHTML = renderTableWithHTML(data, ["狀態","核函號碼(J)","核函到期(L)","入簽/遞補(R)","到期日期(T)","Excel列號","原因"]);
        return;
      }

      if (activeTab === "summary"){
        // summaryRows 結構是 {核函號碼, 可用筆數}；搜尋沿用 applySearch 需轉形
        const q = $("q").value.trim().toLowerCase();
        let list = summaryRows.map(s=>({ khNo:s.核函號碼, cnt:s.可用筆數 }));
        if (q){
          list = list.filter(x => [x.khNo, x.cnt].some(v=> String(v).toLowerCase().includes(q)));
        }
        const data = list.map(x=>({ "核函號碼": x.khNo, "可用筆數": x.cnt }));
        view.innerHTML = renderTable(data, ["核函號碼","可用筆數"]);
        return;
      }
    }

    // Tabs
    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        t.classList.add("active");
        activeTab = t.dataset.tab;
        render();
      });
    });

    // Search
    $("q").addEventListener("input", ()=> render());

    // ===== 分析 =====
    $("analyze").addEventListener("click", async ()=>{
      if (!uploadedFile){
        alert("請先拖曳或選擇 Excel 檔案。");
        return;
      }

      $("download").disabled = true;
      setStatus("解析中…");

      const todayStr = $("today").value;
      const today = todayStr ? dateOnly(new Date(todayStr)) : dateOnly(new Date());

      const buf = await uploadedFile.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array", cellDates: true });

      const sheetName = wb.SheetNames[0];
      lastSheetName = sheetName;
      const ws = wb.Sheets[sheetName];

      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false, defval: null });
      const startRowIdx = detectStartRow(aoa);
      lastStartRow = startRowIdx;

      rows = [];
      for (let i = startRowIdx; i < aoa.length; i++){
        const row = aoa[i] || [];
        const khNo = row[COL.J];
        const L = row[COL.L];
        const R = row[COL.R];
        const T = row[COL.T];

        const isAllEmpty = [khNo,L,R,T].every(v => v === null || v === undefined || String(v).trim() === "");
        if (isAllEmpty) continue;

        const judged = judgeUsable(L, R, T, today);

        rows.push({
          excelRow: i + 1,
          khNo: khNo ?? "",
          khExpire: fmtDate(parseMinguoDate(L)),
          rVal: R ?? "",
          tExpire: fmtDate(parseMinguoDate(T)),
          status: judged.status,
          reason: judged.reason
        });
      }

      usableRows = rows.filter(r=>r.status==="可用");
      unusableRows = rows.filter(r=>r.status!=="可用");
      summaryRows = buildSummary(usableRows);

      $("kpiUsable").textContent = String(usableRows.length);
      $("kpiUnusable").textContent = String(unusableRows.length);
      $("kpiKh").textContent = String(summaryRows.length);
      $("kpiStart").textContent = `第 ${startRowIdx + 1} 列`;

      setStatus(`完成：${uploadedFile.name}（工作表：${sheetName}；資料起始列：第 ${startRowIdx + 1} 列）`);
      $("download").disabled = false;

      bumpUseCount();
      render();
    });

    // ===== 下載結果（選用）=====
    $("download").addEventListener("click", ()=>{
      if (!rows.length) return;

      const all = rows.map(r=>({
        "Excel列號": r.excelRow,
        "核函號碼(J)": r.khNo,
        "核函到期(L)": r.khExpire,
        "入簽/遞補(R)": r.rVal,
        "到期日期(T)": r.tExpire,
        "狀態": r.status,
        "原因": r.reason
      }));

      const usable = usableRows.map(r=>({
        "Excel列號": r.excelRow,
        "核函號碼(J)": r.khNo,
        "核函到期(L)": r.khExpire,
        "入簽/遞補(R)": r.rVal,
        "到期日期(T)": r.tExpire,
        "狀態": r.status,
        "原因": r.reason
      }));

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), "核函彙總");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(usable), "可用清單");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(all), "全部判斷");

      XLSX.writeFile(wb, "核函可用結果.xlsx");
    });
  </script>
</body>
</html>
